<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Recherche Globale de Produits</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 8px;
        text-align: left;
    }
    table {
        width: 100%;
    }
    form {
        margin-bottom: 20px;
    }
</style>
</head>
<body>
<h1>Recherche Globale de Produits (Triés par Prix)</h1>
<form id="searchForm">
    <label for="itemTitle">Titre du produit:</label>
    <input type="text" id="itemTitle" name="itemTitle" value="glasses">
    <label for="maxPrice">Prix Maximum (en Euros):</label>
    <input type="number" id="maxPrice" name="maxPrice" value="5000">
    <button type="button" onclick="fetchProductsGlobal()">Rechercher</button>
    <button type="button" onclick="window.location.reload();">Rafraîchir la Page</button>
</form>
<table id="productsTable">
    <tr>
        <th>Titre</th>
        <th>Prix</th>
        <th>URL</th>
    </tr>
</table>

<script>

async function convertUsdToEur(amount, apiKey) {
    // URL de l'API pour obtenir le taux de change de USD à EUR
    const url = `https://v6.exchangerate-api.com/v6/${apiKey}/pair/USD/EUR`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('La requête API a échoué avec le statut ' + response.status);
        }
        const data = await response.json();
        if (data.result !== 'success') {
            throw new Error('Erreur lors de la récupération du taux de change: ' + data['error-type']);
        }
        // Taux de change USD vers EUR
        const exchangeRate = data.conversion_rate;
        // Conversion du montant en EUR
        const convertedAmount = amount * exchangeRate;
        console.log(`${amount} USD est équivalent à ${convertedAmount.toFixed(2)} EUR.`);
        return convertedAmount;
    } catch (error) {
        console.error('Erreur:', error.message);
        return null;
    }
}

// Exemple d'utilisation
const amountInUsd = 100; // Montant en USD que tu veux convertir
const apiKey = '644d8bf47a56130b1d1b62db';
convertUsdToEur(amountInUsd, apiKey);

function fetchProductsAliexpress() {
    const itemTitle = document.getElementById('itemTitle').value;
    const maxPrice = document.getElementById('maxPrice').value;
    const apiUrl = "https://otapi-aliexpress.p.rapidapi.com/BatchSearchItemsFrame";
    const params = new URLSearchParams({
        language: "fr",
        framePosition: "0",
        frameSize: "14",
        ItemTitle: itemTitle,
        OrderBy: "Popularity:Desc",
        MaxPrice: maxPrice,
        currency: 'USD'
    });
    const headers = {
        "X-RapidAPI-Key": "b9ee6a42a7mshe7386d9bc393dadp14419fjsn8ae618abbf42",
        "X-RapidAPI-Host": "otapi-aliexpress.p.rapidapi.com"
    };
    return axios.get(`${apiUrl}?${params}`, { headers });
}

function fetchProductsEbay() {
    const itemTitle = document.getElementById('itemTitle').value;
    const apiUrl = "https://ebay-data-scraper.p.rapidapi.com/products";
    const params = { page_number: "1", product_name: itemTitle };
    const headers = {
        "X-RapidAPI-Key": "b9ee6a42a7mshe7386d9bc393dadp14419fjsn8ae618abbf42",
        "X-RapidAPI-Host": "ebay-data-scraper.p.rapidapi.com"
    };
    return axios.get(apiUrl, { headers: headers, params: params });
}

function fetchProductsAmazon() {
    const itemTitle = document.getElementById('itemTitle').value;
    const maxPrice = document.getElementById('maxPrice').value;
    const apiUrl = "https://real-time-amazon-data.p.rapidapi.com/search";
    const params = new URLSearchParams({
        query: itemTitle,
        page: "1",
        country: "US",
        sort_by: "RELEVANCE",
        category_id: "aps",
        max_price: maxPrice
    });
    const headers = {
        "X-RapidAPI-Key": "b9ee6a42a7mshe7386d9bc393dadp14419fjsn8ae618abbf42",
        "X-RapidAPI-Host": "real-time-amazon-data.p.rapidapi.com"
    };
    return axios.get(`${apiUrl}?${params.toString()}`, { headers: headers });
}

async function fetchProductsGlobal() {
    try {
        const [aliexpressResponse, ebayResponse, amazonResponse] = await Promise.all([
            fetchProductsAliexpress(),
            fetchProductsEbay(),
            fetchProductsAmazon()
        ]);

        const aliexpressProducts = aliexpressResponse.data.Result.Items.Items.Content.map(product => ({
            title: product.Title,
            price: parseFloat(product.Price.ConvertedPriceWithoutSign),
            url: product.ExternalItemUrl,
            source: 'AliExpress'
        }));

        const ebayProducts = ebayResponse.data.map(product => ({
            title: product.name,
            price: parseFloat(product.price.replace(/[^\d.-]/g, '')),
            url: product.link,
            source: 'eBay'
        }));

        const amazonProducts = amazonResponse.data.data.products.map(product => ({
            title: product.product_title,
            price: parseFloat(product.product_price.replace(/[^0-9.-]+/g, "")),
            url: product.product_url,
            source: 'Amazon'
        }));

        const allProducts = [...aliexpressProducts, ...ebayProducts, ...amazonProducts];
        allProducts.sort((a, b) => a.price - b.price);

        const table = document.getElementById('productsTable');
        while (table.rows.length > 1) {
            table.deleteRow(1);
        }

        allProducts.forEach(product => {
            const row = table.insertRow();
            const titleCell = row.insertCell(0);
            const priceCell = row.insertCell(1);
            const urlCell = row.insertCell(2);

            titleCell.textContent = product.title;
            priceCell.textContent = `${product.price.toFixed(2)} ${product.source === 'AliExpress' ? 'EUR' : 'USD'}`;
            const link = document.createElement('a');
            link.href = product.url;
            link.textContent = `Voir sur ${product.source}`;
            link.target = "_blank";
            urlCell.appendChild(link);
        });
    } catch (error) {
        console.error("Failed to retrieve data:", error);
    }
}
</script>
</body>
</html>
