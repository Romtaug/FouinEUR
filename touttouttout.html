<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="images/logo.png">
    <img src="images/logo.png" alt="Logo FouinEUR" style="position: absolute; top: 15px; right: 60px; width: 70px; height: auto;">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FouinEUR</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Bienvenue sur FouinEUR !</h1>
    </header>
    <main>
        <section>
            <p>Bienvenue chers chasseurs de bonnes affaires, sur FouinEUR.fr, la plateforme ultime dédiée à tous les radins et les crevards qui se respectent ! Notre mission ? Vous aider à dénicher les meilleures offres sur le web, tout en vous assurant de ne jamais payer un euro de plus que nécessaire. Que vous soyez à la recherche de gadgets high-tech, de vêtements à la mode, d'accessoires pour la maison ou de tout autre produit, nous scrutons les quatre coins de l'internet pour vous apporter les deals les plus alléchants.</p>
        </section>
        <div class="tenor-gif-embed small-gif" data-postid="12610730076118899182" data-share-method="host" data-aspect-ratio="1.75352" data-width="100%">
            <a href="https://tenor.com/view/je-ne-suis-pas-radin-gif-12610730076118899182">Je Ne Suis Pas Radin GIF</a> de 
            <a href="https://tenor.com/search/je+ne+suis+pas+radin-gifs">Je Ne Suis Pas Radin GIFs</a>
        </div>
        <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
        <section>
            <ul>
                <li><strong>Recherche globale de produits :</strong> Entrez le nom du produit et laissez notre algorithme chercher les meilleures offres pour vous.</li>
                <li><strong>Comparaison de prix :</strong> Visualisez les prix de différents vendeurs pour le même produit et choisissez l'offre la plus avantageuse.</li>
                <li><strong>Alertes de prix :</strong> Définissez des alertes pour vos produits préférés et soyez notifiés dès que les prix baissent.</li>
                <li><strong>Conseils de radin :</strong> Des guides et des astuces pour maximiser vos économies sur chaque achat.</li>
            </ul>
        </section>
        <form id="searchForm">
            <div class="form-controls">
                <input type="text" id="itemTitle" name="itemTitle" placeholder="ex : Rolex" required>
                <button type="button" onclick="fetchProductsGlobal()">Rechercher</button>
                <button type="button" onclick="window.location.reload();">Nouvelle recherche</button>
            </div>
        </form>
        
<table id="productsTable">
    <tr>
        <th>Titre</th>
        <th>Prix</th>
        <th>URL d'affiliation</th>
    </tr>
</table>

<script>
async function convertUsdToEur(amount, apiKey) {
    const url = `https://v6.exchangerate-api.com/v6/${apiKey}/pair/USD/EUR`;
    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('La requête API a échoué avec le statut ' + response.status);
        }
        const data = await response.json();
        if (data.result !== 'success') {
            throw new Error('Erreur lors de la récupération du taux de change: ' + data['error-type']);
        }
        return data.conversion_rate;
    } catch (error) {
        console.error('Erreur:', error.message);
        return null;
    }
}

async function fetchProductsGlobal() {
    const apiKey = '644d8bf47a56130b1d1b62db';  // Assurez-vous de sécuriser votre clé API dans une application de production
    const exchangeRate = await convertUsdToEur(1, apiKey); // Obtient le taux de change actuel

    const itemTitle = document.getElementById('itemTitle').value;

    // Configurations des appels API pour AliExpress, eBay, et Amazon
    const aliexpressResponse = await fetchProductsAliexpress(itemTitle);
    const ebayResponse = await fetchProductsEbay(itemTitle);
    const amazonResponse = await fetchProductsAmazon(itemTitle);

    const aliexpressProducts = aliexpressResponse.data.Result.Items.Items.Content.map(product => {
        let displayedPrice = product.PromotionPrice && product.PromotionPrice.MarginPrice
            ? parseFloat(product.PromotionPrice.MarginPrice)  // Utiliser le prix promotionnel si disponible
            : parseFloat(product.Price.ConvertedPriceWithoutSign);  // Sinon utiliser le prix original

        displayedPrice = displayedPrice * exchangeRate;

        return {
            title: product.Title,
            price: parseFloat(displayedPrice),  // Utilisation du prix formaté
            url: product.ExternalItemUrl,
            source: 'AliExpress'
        };
    });

    const ebayProducts = ebayResponse.data.map(product => ({
        title: product.name,
        price: parseFloat(product.price.replace(/[^\d.-]/g, '')) * exchangeRate,
        url: product.link,
        source: 'eBay'
    }));

    const amazonProducts = amazonResponse.data.data.products.map(product => ({
        title: product.product_title,
        price: parseFloat(product.product_price.replace(/[^0-9.-]+/g, "")) * exchangeRate,
        url: product.product_url,
        source: 'Amazon'
    }));

    const allProducts = [...aliexpressProducts, ...ebayProducts, ...amazonProducts];
    allProducts.sort((a, b) => a.price - b.price);

    const table = document.getElementById('productsTable');
    while (table.rows.length > 1) {
        table.deleteRow(1);
    }

    allProducts.forEach(product => {
        const row = table.insertRow();
        const titleCell = row.insertCell(0);
        const priceCell = row.insertCell(1);
        const urlCell = row.insertCell(2);

        titleCell.textContent = product.title;
        priceCell.textContent = `${product.price.toFixed(2)} €`;
        const link = document.createElement('a');
        link.href = product.url;
        link.textContent = `Voir sur ${product.source}`;
        link.target = "_blank";
        urlCell.appendChild(link);
    });
}

// Fonctions spécifiques pour les appels API
async function fetchProductsAliexpress(itemTitle) {
    const apiUrl = "https://otapi-aliexpress.p.rapidapi.com/BatchSearchItemsFrame";
    const params = new URLSearchParams({
        language: "en",
        framePosition: "0",
        frameSize: "14",
        ItemTitle: itemTitle,
        OrderBy: "Popularity:Desc",
        MaxPrice: "100000000",
    });
    const headers = {
        "X-RapidAPI-Key": "b9ee6a42a7mshe7386d9bc393dadp14419fjsn8ae618abbf42",
        "X-RapidAPI-Host": "otapi-aliexpress.p.rapidapi.com"
    };
    return axios.get(`${apiUrl}?${params}`, { headers });
}

async function fetchProductsEbay(itemTitle) {
    const apiUrl = "https://ebay-data-scraper.p.rapidapi.com/products";
    const params = { page_number: "1", product_name: itemTitle };
    const headers = {
        "X-RapidAPI-Key": "b9ee6a42a7mshe7386d9bc393dadp14419fjsn8ae618abbf42",
        "X-RapidAPI-Host": "ebay-data-scraper.p.rapidapi.com"
    };
    return axios.get(apiUrl, { headers: headers, params: params });
}

async function fetchProductsAmazon(itemTitle) {
    const apiUrl = "https://real-time-amazon-data.p.rapidapi.com/search";
    const params = new URLSearchParams({
        query: itemTitle,
        page: "1",
        country: "US",
        sort_by: "RELEVANCE",
        category_id: "aps"
    });
    const headers = {
        "X-RapidAPI-Key": "b9ee6a42a7mshe7386d9bc393dadp14419fjsn8ae618abbf42",
        "X-RapidAPI-Host": "real-time-amazon-data.p.rapidapi.com"
    };
    return axios.get(`${apiUrl}?${params.toString()}`, { headers: headers });
}
</script>
<br/>
<br/>
<br/>

<footer style="text-align: center;">
    <pstyle="text-align: center;"></pstyle>&copy; 2024 FouinEUR. Tous droits réservés - Romain Taugourdeau</p>
</footer>

</body>
</html>
